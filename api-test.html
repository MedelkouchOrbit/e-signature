<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Error Handling</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .success { color: #2e7d32; background: #e8f5e9; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .info { color: #1976d2; background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; border: none; border-radius: 4px; }
        .test-btn { background: #1976d2; color: white; }
        .fix-btn { background: #2e7d32; color: white; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Parse Server API Connectivity Test</h1>
        
        <div class="info">
            <h3>‚úÖ Backend Status: RESOLVED</h3>
            <p>The OpenSign Parse Server API at <code>http://94.249.71.89:9000</code> has been fixed and now properly serves JSON API responses!</p>
            <p><strong>Status:</strong> ‚úÖ API Accessible - Enhanced backend integration active</p>
            <p><strong>Update:</strong> All endpoints now return proper JSON responses with enhanced signPdf functionality</p>
        </div>

        <div class="test-section">
            <h3>üß™ Test API Connectivity</h3>
            <button class="test-btn" onclick="testProxyAPI()">Test Proxy API</button>
            <button class="test-btn" onclick="testDirectAPI()">Test Direct API</button>
            <button class="test-btn" onclick="testSignDocument()">Test Document Signing</button>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>üîë Authentication Test</h3>
            <p>Testing with credentials: <code>joe@joe.com</code> / <code>Meticx12@</code></p>
            <button class="test-btn" onclick="testAuthentication()">Test Login</button>
            <div id="auth-results"></div>
        </div>

        <div class="test-section">
            <h3>üìã Backend Requirements</h3>
            <div class="error">
                <h4>BACKEND TEAM ACTION REQUIRED:</h4>
                <ol>
                    <li>Mount Parse Server on <code>/1</code> path</li>
                    <li>Expose API endpoints properly</li>
                    <li>Verify cloud functions are accessible</li>
                    <li>Test authentication endpoints</li>
                </ol>
            </div>
            
            <h4>Expected API Endpoints (after fix):</h4>
            <pre>
POST http://94.249.71.89:9000/1/login
POST http://94.249.71.89:9000/1/functions/signPdf
GET  http://94.249.71.89:9000/1/classes/contracts_Document</pre>
        </div>

        <div class="test-section">
            <h3>üí° Testing Instructions</h3>
            <p>Once the backend team fixes the Parse Server mounting:</p>
            <ol>
                <li>Click "Test Login" to verify authentication works</li>
                <li>Click "Test Document Signing" to check signing functionality</li>
                <li>Verify the main application signing workflow</li>
            </ol>
        </div>
    </div>

    <script>
        async function testProxyAPI() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>üîÑ Testing proxy API...</p>';
            
            try {
                const response = await fetch('/api/proxy/opensign/classes/contracts_Document');
                const text = await response.text();
                
                if (text.includes('<!DOCTYPE html>')) {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Proxy Test Failed</h4>
                            <p>Received HTML frontend instead of API response</p>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Issue:</strong> Parse Server API not mounted properly</p>
                        </div>`;
                } else {
                    try {
                        const data = JSON.parse(text);
                        resultsDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ Proxy Test Success</h4>
                                <p>API response received</p>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>`;
                    } catch {
                        resultsDiv.innerHTML = `
                            <div class="error">
                                <h4>‚ùå Invalid API Response</h4>
                                <p>Response is not valid JSON</p>
                                <pre>${text.substring(0, 200)}...</pre>
                            </div>`;
                    }
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Connection Error</h4>
                        <p>${error.message}</p>
                    </div>`;
            }
        }

        async function testDirectAPI() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>üîÑ Testing direct API...</p>';
            
            try {
                const response = await fetch('http://94.249.71.89:9000/1/classes/contracts_Document', {
                    headers: {
                        'X-Parse-Application-Id': 'opensign'
                    }
                });
                const text = await response.text();
                
                if (text.includes('<!DOCTYPE html>')) {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Direct API Test Failed</h4>
                            <p>Parse Server not mounted on /1 path</p>
                            <p>Received frontend HTML instead of API</p>
                        </div>`;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Direct API Available!</h4>
                            <p>Parse Server API is accessible</p>
                        </div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå CORS or Connection Error</h4>
                        <p>Cannot access direct API from browser</p>
                        <p>This is expected due to CORS - use proxy instead</p>
                    </div>`;
            }
        }

        async function testAuthentication() {
            const resultsDiv = document.getElementById('auth-results');
            resultsDiv.innerHTML = '<p>üîÑ Testing authentication...</p>';
            
            try {
                const response = await fetch('/api/proxy/opensign/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'joe@joe.com',
                        password: 'Meticx12@'
                    })
                });
                
                const text = await response.text();
                
                if (text.includes('<!DOCTYPE html>')) {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Authentication Failed</h4>
                            <p>Parse Server login endpoint not accessible</p>
                            <p>Backend needs to mount Parse Server properly</p>
                        </div>`;
                } else {
                    try {
                        const data = JSON.parse(text);
                        if (data.sessionToken) {
                            resultsDiv.innerHTML = `
                                <div class="success">
                                    <h4>‚úÖ Authentication Success!</h4>
                                    <p>Login endpoint is working</p>
                                    <p><strong>Session Token:</strong> ${data.sessionToken.substring(0, 20)}...</p>
                                </div>`;
                            
                            // Store session token for other tests
                            localStorage.setItem('opensign_session_token', data.sessionToken);
                        } else {
                            resultsDiv.innerHTML = `
                                <div class="error">
                                    <h4>‚ùå Authentication Failed</h4>
                                    <p>Invalid credentials or API error</p>
                                    <pre>${JSON.stringify(data, null, 2)}</pre>
                                </div>`;
                        }
                    } catch {
                        resultsDiv.innerHTML = `
                            <div class="error">
                                <h4>‚ùå Invalid Response</h4>
                                <p>Not a valid JSON response</p>
                                <pre>${text.substring(0, 200)}...</pre>
                            </div>`;
                    }
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Connection Error</h4>
                        <p>${error.message}</p>
                    </div>`;
            }
        }

        async function testSignDocument() {
            const resultsDiv = document.getElementById('test-results');
            const sessionToken = localStorage.getItem('opensign_session_token');
            
            if (!sessionToken) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå No Session Token</h4>
                        <p>Please run authentication test first</p>
                    </div>`;
                return;
            }
            
            resultsDiv.innerHTML = '<p>üîÑ Testing document signing function...</p>';
            
            try {
                const response = await fetch('/api/proxy/opensign/functions/signPdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        docId: 'test123',
                        signature: 'test signature'
                    })
                });
                
                const text = await response.text();
                
                if (text.includes('<!DOCTYPE html>')) {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Signing Function Not Available</h4>
                            <p>Parse Server functions not accessible</p>
                            <p>Backend team needs to expose cloud functions</p>
                        </div>`;
                } else {
                    try {
                        const data = JSON.parse(text);
                        resultsDiv.innerHTML = `
                            <div class="success">
                                <h4>‚úÖ Signing Function Available!</h4>
                                <p>Cloud functions are accessible</p>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>`;
                    } catch {
                        resultsDiv.innerHTML = `
                            <div class="info">
                                <h4>‚ÑπÔ∏è Function Response</h4>
                                <p>Got non-JSON response (might be expected for test data)</p>
                                <pre>${text.substring(0, 200)}...</pre>
                            </div>`;
                    }
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Function Test Error</h4>
                        <p>${error.message}</p>
                    </div>`;
            }
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            console.log('üîß Parse Server API Test Page Loaded');
            console.log('üìã Issue: Parse Server API endpoints not accessible');
            console.log('üéØ Solution: Backend team needs to mount Parse Server on /1 path');
        };
    </script>
</body>
</html>
