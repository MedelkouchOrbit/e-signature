<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams API Backend Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.warning { background-color: #fff3cd; color: #856404; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teams API Backend Test Suite</h1>
        
        <div class="test-section">
            <h3>Test Configuration</h3>
            <p>This test suite validates all Teams API backend functionalities including:</p>
            <ul>
                <li>User authentication and details</li>
                <li>Teams data retrieval</li>
                <li>Team members management</li>
                <li>Password generation</li>
                <li>API service availability</li>
            </ul>
            
            <div>
                <label for="apiBaseUrl">API Base URL:</label>
                <input type="text" id="apiBaseUrl" value="http://localhost:1337/parse" style="width: 300px; padding: 5px; margin: 10px;">
            </div>
            
            <div>
                <label for="sessionToken">Session Token (if available):</label>
                <input type="text" id="sessionToken" placeholder="Enter session token..." style="width: 400px; padding: 5px; margin: 10px;">
            </div>
        </div>

        <div class="test-section">
            <h3>Individual Tests</h3>
            <button class="test-button" onclick="testApiConnection()">Test API Connection</button>
            <button class="test-button" onclick="testUserDetails()">Test User Details</button>
            <button class="test-button" onclick="testGetTeams()">Test Get Teams</button>
            <button class="test-button" onclick="testGetTeamMembers()">Test Get Team Members</button>
            <button class="test-button" onclick="testPasswordGeneration()">Test Password Generation</button>
            <button class="test-button" onclick="runFullTestSuite()" style="background-color: #28a745;">Run All Tests</button>
        </div>

        <div class="test-section">
            <h3>Test Results</h3>
            <div id="testResults" class="result-box">
                Click "Run All Tests" to start testing the Teams API backend...
            </div>
        </div>

        <div class="test-section">
            <h3>API Status</h3>
            <div id="apiStatus">
                <span class="status info">Not tested</span>
            </div>
        </div>
    </div>

    <script>
        // Mock API service for testing
        const mockApiService = {
            baseUrl: 'http://localhost:1337/parse',
            sessionToken: null,
            
            async post(endpoint, data) {
                const url = `${this.baseUrl}/${endpoint.replace(/^\//, '')}`
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Parse-Application-Id': 'opensign'
                }
                
                if (this.sessionToken) {
                    headers['X-Parse-Session-Token'] = this.sessionToken
                }
                
                console.log('üåê API Request:', { url, data, headers })
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(data)
                    })
                    
                    const result = await response.json()
                    console.log('üì• API Response:', result)
                    
                    return result
                } catch (error) {
                    console.error('‚ùå API Error:', error)
                    throw error
                }
            }
        }

        // Teams API service implementation
        const teamsApiService = {
            async getCurrentUserDetails() {
                try {
                    const response = await mockApiService.post('functions/getUserDetails', {})
                    
                    if (response.error) {
                        throw new Error(`Failed to get user details: ${response.error}`)
                    }
                    
                    return {
                        organization: response.result?.OrganizationId ? {
                            objectId: response.result.OrganizationId.objectId,
                            company: response.result.OrganizationId.Name
                        } : undefined,
                        tenantId: response.result?.TenantId?.objectId,
                        role: response.result?.UserRole
                    }
                } catch (error) {
                    console.error('Error fetching user details:', error)
                    throw error
                }
            },

            async getTeams() {
                try {
                    const response = await mockApiService.post('functions/getteams', {
                        active: true
                    })
                    
                    if (response.error) {
                        throw new Error(`OpenSign API Error: ${response.error}`)
                    }
                    
                    return response.result || []
                } catch (error) {
                    console.error('Error fetching teams:', error)
                    throw error
                }
            },

            async getTeamMembers() {
                try {
                    // First get current user details to get organization ID
                    const userResponse = await mockApiService.post('functions/getUserDetails', {})
                    
                    if (userResponse.error) {
                        throw new Error(`Failed to get user details: ${userResponse.error}`)
                    }
                    
                    const organizationId = userResponse.result?.OrganizationId?.objectId
                    if (!organizationId) {
                        return []
                    }
                    
                    // Get team members by organization
                    const response = await mockApiService.post('functions/getUserListByOrg', {
                        organizationId
                    })
                    
                    if (response.error) {
                        throw new Error(`OpenSign API Error: ${response.error}`)
                    }
                    
                    return response.result || []
                } catch (error) {
                    console.error('Error fetching team members:', error)
                    throw error
                }
            },

            generatePassword(length = 12) {
                const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*"
                let password = ""
                for (let i = 0; i < length; i++) {
                    password += charset.charAt(Math.floor(Math.random() * charset.length))
                }
                return password
            }
        }

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults')
            const timestamp = new Date().toLocaleTimeString()
            const logEntry = `[${timestamp}] ${message}\n`
            resultsDiv.textContent += logEntry
            resultsDiv.scrollTop = resultsDiv.scrollHeight
            
            // Update status
            const statusDiv = document.getElementById('apiStatus')
            let statusClass = 'info'
            if (message.includes('‚úÖ') || message.includes('Success')) statusClass = 'success'
            else if (message.includes('‚ùå') || message.includes('Error')) statusClass = 'error'
            else if (message.includes('‚ö†Ô∏è') || message.includes('Warning')) statusClass = 'warning'
            
            statusDiv.innerHTML = `<span class="status ${statusClass}">${message.split(']')[1] || message}</span>`
        }

        function clearResults() {
            document.getElementById('testResults').textContent = ''
        }

        function updateApiConfig() {
            mockApiService.baseUrl = document.getElementById('apiBaseUrl').value
            mockApiService.sessionToken = document.getElementById('sessionToken').value || null
        }

        async function testApiConnection() {
            updateApiConfig()
            clearResults()
            log('üîç Testing API connection...')
            
            try {
                const response = await fetch(mockApiService.baseUrl + '/health')
                if (response.ok) {
                    log('‚úÖ API connection successful')
                } else {
                    log('‚ö†Ô∏è API responded but with error status: ' + response.status)
                }
            } catch (error) {
                log('‚ùå API connection failed: ' + error.message)
            }
        }

        async function testUserDetails() {
            updateApiConfig()
            log('üë§ Testing user details...')
            
            try {
                const userDetails = await teamsApiService.getCurrentUserDetails()
                log('‚úÖ User details retrieved successfully:')
                log('   Organization: ' + (userDetails.organization?.company || 'None'))
                log('   Tenant ID: ' + (userDetails.tenantId || 'None'))
                log('   Role: ' + (userDetails.role || 'None'))
            } catch (error) {
                log('‚ùå User details test failed: ' + error.message)
            }
        }

        async function testGetTeams() {
            updateApiConfig()
            log('üè¢ Testing get teams...')
            
            try {
                const teams = await teamsApiService.getTeams()
                log(`‚úÖ Teams retrieved successfully: ${teams.length} teams found`)
                
                if (teams.length > 0) {
                    log('   Sample team: ' + teams[0].Name)
                } else {
                    log('   No teams found')
                }
            } catch (error) {
                log('‚ùå Get teams test failed: ' + error.message)
            }
        }

        async function testGetTeamMembers() {
            updateApiConfig()
            log('üë• Testing get team members...')
            
            try {
                const members = await teamsApiService.getTeamMembers()
                log(`‚úÖ Team members retrieved successfully: ${members.length} members found`)
                
                if (members.length > 0) {
                    const member = members[0]
                    log('   Sample member: ' + member.Name + ' (' + member.Email + ')')
                } else {
                    log('   No team members found')
                }
            } catch (error) {
                log('‚ùå Get team members test failed: ' + error.message)
            }
        }

        function testPasswordGeneration() {
            log('üîê Testing password generation...')
            
            try {
                const password1 = teamsApiService.generatePassword(8)
                const password2 = teamsApiService.generatePassword(12)
                const password3 = teamsApiService.generatePassword(16)
                
                log('‚úÖ Password generation successful:')
                log('   8-char: ' + password1)
                log('   12-char: ' + password2)
                log('   16-char: ' + password3)
                
                // Test password strength
                const hasUppercase = /[A-Z]/.test(password2)
                const hasLowercase = /[a-z]/.test(password2)
                const hasNumbers = /[0-9]/.test(password2)
                const hasSpecialChars = /[!@#$%^&*]/.test(password2)
                
                log('   Password strength check:')
                log('   - Uppercase: ' + hasUppercase)
                log('   - Lowercase: ' + hasLowercase)
                log('   - Numbers: ' + hasNumbers)
                log('   - Special chars: ' + hasSpecialChars)
                
            } catch (error) {
                log('‚ùå Password generation test failed: ' + error.message)
            }
        }

        async function runFullTestSuite() {
            clearResults()
            log('üöÄ Starting full Teams API test suite...')
            log('=' + '='.repeat(50))
            
            updateApiConfig()
            
            // Test API connection
            await testApiConnection()
            log('')
            
            // Test user details
            await testUserDetails()
            log('')
            
            // Test teams
            await testGetTeams()
            log('')
            
            // Test team members
            await testGetTeamMembers()
            log('')
            
            // Test password generation
            testPasswordGeneration()
            log('')
            
            log('=' + '='.repeat(50))
            log('üéØ Test suite completed!')
            log('Check the results above for any issues.')
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('Teams API Test Suite loaded and ready.')
            log('Configure the API settings above and click "Run All Tests" to start.')
        })
    </script>
</body>
</html>
